<!DOCTYPE html>

<html lang="ko">
<head>
<meta charset="utf-8"/>
  <!-- Ensure responsive behavior: without this, mobile browsers use a desktop viewport
       and CSS media queries (max-width/min-width) won't match as expected. -->
  <meta name="viewport" content="width=device-width, initial-scale=1">
<title>OX 퀴즈</title>
<style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: 'Malgun Gothic', sans-serif;
      background-image: url('색.png');
      background-size: cover;
    }
    .quiz-box {
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      height: 80vh;
      text-align: center;
      position: relative;
      border: 8px solid #2196f3;
      background-color: white;
      border-radius: 20px;
      box-sizing: border-box;
      padding: 20px;
      max-width: 90%;
      margin: 5vh auto;
    }
    .question {
      max-width: 800px;
      width: 100%;
      word-break: keep-all;
      /* use margin/padding for spacing instead of translate to keep flow predictable */
      margin-top: 20px;
    }
    .answer-buttons {
      display: flex;
      justify-content: space-evenly;
      gap: 50px;
      width: 100%;
      padding: 0 10px;
      margin-top: 60px;
      margin-bottom: 60px;
      box-sizing: border-box;
    }
    .btn {
      width: 67.5vw;
      height: 67.5vw;
      max-width: 262.5px;
      max-height: 262.5px;
      font-size: 12vw;
      font-weight: bold;
      border: none;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    }
    .btn.o, .btn.x {
      background-color: transparent;
      padding: 0;
      border-radius: 0;
      box-shadow: none;
    }
    .btn.o img, .btn.x img {
      width: 350px;
      height: 350px;
      object-fit: contain;
      max-width: 40vw;
    }
    .btn.next, .btn.stats, .btn.reset {
      font-size: 35px;
      padding: 4px 8px;
      background-color: #607d8b;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      height: 88px;
      line-height: 1.2;
      margin-top: 20px;
    }
    .judgement.correct {
      color: #2196f3;
      font-size: 68px;
      font-weight: bold;
    }
    .judgement.wrong {
      color: #ff9800;
      font-size: 68px;
      font-weight: bold;
    }
    #finalScreen img {
      width: 507px;
      margin-bottom: 20px;
    }
    .bottom-img {
      width: 60%;
      position: absolute;
      bottom: 10px;
      left: 50%;
      transform: translateX(-50%);
      pointer-events: none; /* don't block buttons on desktop */
    }

.topright-logo {
  position: absolute;
  top: 20px;
  right: 20px;
  height: 72px;
}
/* Image wrapper: make the image a predictable reference for absolute labels */
.quiz-image-wrap {
  position: relative;
  width: 100%;
  max-width: 650px; /* default max; media queries may override */
  margin: 0 auto;
}
.quiz-image-wrap img { display:block; width:100%; height:auto; }

/* Center the label horizontally and vertically inside the image wrapper.
   Use translate(-50%, -50%) so the label stays centered regardless of image size.
   Font-size is responsive using clamp so it won't overflow the banner. */
#quizLabel {
  position: absolute;
  /* move up 15px to align with explanation label adjustments */
  top: calc(50% - 10px);
  /* shift label 50px left relative to previous center offset (was -20px -> now -70px) */
  left: calc(50% - 0px);
  transform: translate(-50%, -50%);
  z-index: 2;
  pointer-events: none;
  font-family: 'Arial Black', 'Malgun Gothic', sans-serif;
  font-weight: 700;
  white-space: nowrap;
  font-size: clamp(28px, 4.5vw, 44px);
  color: #0a2c5d;
}

/* Explanation label used on the explanation screen */
.explanation-label {
    position: absolute;
    /* move up 15px relative to the centered position */
    top: calc(50% - 15px);
    /* shift explanation label 50px further left (was -20px -> now -70px) */
    left: calc(50% - 40px);
    transform: translate(-50%, -50%);
  z-index: 2;
  pointer-events: none;
  font-family: 'Arial Black', 'Malgun Gothic', sans-serif;
  font-weight: 700;
  white-space: nowrap;
  font-size: clamp(28px, 4.5vw, 40px);
  color: #0a2c5d;
}
</style>
<style>
  /* Desktop-specific layout tweaks to avoid buttons being covered and
     to make better use of horizontal space on wider screens. */
  @media (min-width: 1024px) {
    .quiz-box {
      max-width: 880px;
      height: 80vh;
      padding: 20px 28px; /* tighten padding so content has more space */
      padding-top: 48px; /* allow room for header/logo */
      box-sizing: border-box;
      overflow: visible; /* allow controls to sit above decorative images */
    }
    .question { font-size: 30px; line-height:1.15; }
    /* Move the quiz label higher (closer to top of the background image) and reduce size so it doesn't overlap header */
  #quizLabel { font-size: 34px; }
  /* keep the wrapper centered; nudge only the image by 3px so the visible
     yellow banner shifts right while the centered label remains fixed */
  .quiz-image-wrap { transform: none; }
  .quiz-image-wrap img { transform: translateX(100px); }
    .answer-buttons { gap: 64px; }
    .btn {
      width: 160px;
      height: 160px;
      max-width: none;
      max-height: none;
      font-size: 36px;
      border-radius: 50%;
    }
    .btn.o img, .btn.x img { width: 160px; height: 160px; }
    .btn.next, .btn.stats, .btn.reset {
      font-size: 18px;
      height: 52px;
      padding: 8px 14px;
      border-radius: 8px;
    }
    .btn.next { z-index: 20; position: relative; }
    .judgement.correct, .judgement.wrong { font-size: 60px; }
  /* final screen image smaller so text below is visible */
  #finalScreen img { width: 300px; height: auto; }
    /* reduce decorative images on desktop so they don't dominate the layout */
    /* override some inline widths to ensure effect */
  #questionImage { width: 320px; height: auto; }
  #intro img:not(.topright-logo) { width: 46%; max-width: 520px; }
  .bottom-img { width: 18%; bottom: 18px; }
    /* logo slightly smaller on desktop to free vertical space */
    .topright-logo { height: 40px; }
    /* slightly reduce prominent text sizes on desktop */
  .question { font-size: 28px; }
  .judgement.correct, .judgement.wrong { font-size: 44px; }
  #finalResult { font-size: 40px; }

  /* override inline-large quiz label and explanation text and images */
  #quizLabel { font-size: 34px; }
  /* explanation background image and label */
  #explanationBox > div > img { width: 320px; height: auto; }
  /* nudge the explanation label left 50px and up 15px on desktop
    (preserve the existing transform behavior while offsetting position) */
  #explanationBox > div > div { font-size: 32px; top: calc(48% - 15px); left: calc(55% - 30px); transform: translateX(-50%) translateY(0); }
  /* ensure the explanation text block that follows the image fits */
  /* increase desktop explanation text by 80% (30px -> 54px) */
  #explanationText { font-size: 75px; line-height:1.2; }
  /* shrink final screen paragraphs so they stay inside the bordered box */
  #finalScreen p { font-size: 26px; }
  }
</style>
<!-- Large-desktop (≈1920×1080) tuning -->
<style>
  @media (min-width: 1600px) {
  .quiz-box { max-width: 1000px; padding-top: 40px; }
  #questionImage { width: 460px; height: auto; }
  /* keep label centered via .quiz-image-wrap; just increase font-size for large screens */
  #quizLabel { font-size: 44px; line-height: 1; }
  #explanationBox > div > img { width: 460px; height: auto; }
  .explanation-label { font-size: 40px; line-height: 1; }
  /* keep the wrapper centered on large desktop as well; a small 3px image
    nudge is enough to move the visible yellow banner */
  .quiz-image-wrap { transform: none; }
  .quiz-image-wrap img { transform: translateX(100px); }
  #finalScreen img { width: 340px; height: auto; }
  #finalResult { font-size: 44px; }
  #finalScreen p { font-size: 28px; }
  .btn { width: 180px; height: 180px; font-size: 40px; }
  .btn.o img, .btn.x img { width: 180px; height: 180px; }
}
</style>
<!-- Mobile tweaks -->
<style>
  /* Mobile: keep viewport-based responsive behavior but make sizes conservative
     so images/buttons don't overflow and elements don't overlap. This preserves
     the desktop rules while ensuring the mobile presentation is tidy. */
  @media (max-width: 767px) {
    /* Make the main boxed container adapt to short/tall viewports */
    .quiz-box {
      max-width: 96%;
      margin: 3vh auto;
      height: auto;
      min-height: calc(100vh - 40px);
      padding: 16px;
      box-sizing: border-box;
    }

    /* Reduce large inline images used on the intro/final screens */
    #intro img:not(.topright-logo),
    #intro img:not(.topright-logo),
    .quiz-image-wrap img,
    #finalScreen img {
      width: 80%;
      max-width: 420px;
      height: auto;
    }

    /* smaller top-right logo on mobile */
    .topright-logo { height: 36px; top: 12px; right: 12px; }

    /* reduce bottom decorative image so it doesn't compete with controls */
    .bottom-img { width: 30%; bottom: 12px; }

    /* Make O/X controls reasonable size on small screens */
    .btn { width: auto; height: auto; box-shadow: none; }
    .btn.o, .btn.x { display: inline-flex; align-items: center; justify-content: center; width: 48%; max-width: 180px; height: auto; border-radius: 50%; }
    .btn.o img, .btn.x img { width: 48vw; max-width: 160px; height: auto; }

    .btn.next, .btn.stats, .btn.reset { height: 48px; font-size: 18px; padding: 8px 14px; border-radius: 8px; }

    .question { font-size: 24px; }
    .judgement.correct, .judgement.wrong { font-size: 36px; }
    #finalResult { font-size: 32px; }

    /* Explanation label: small, stable nudge; remove debug outline */
    .explanation-label {
      top: 50%;
      left: 50%;
      transform: translate(calc(-50% + 30px), calc(-50% + 5px));
      font-size: clamp(20px, 6.5vw, 32px);
      outline: none;
      z-index: 3;
    }

    /* Mobile: make explanation text ~25px (about 1.5x the 1/3 reduction) */
  /* increase mobile explanation text by 50% */
  #explanationText { font-size: 50px; line-height:1.3; }

    /* Defensive: ensure intro fixed inline widths don't force horizontal scroll */
    #intro img[alt="인트로 퀴즈"],
    #intro img[alt="가로형 이미지"] { width: 70%; max-width: 420px; }
  }
</style>
<!-- Force explanation text to be ~1/3 of previous size for readability -->
<style>
  #explanationText { font-size: calc(50px / 3); line-height: 1.25; }
</style>
</head>
<body>
<div class="quiz-box" id="intro">
  <img alt="기관 로고" class="topright-logo" src="제목 없음.png"/>
  <img alt="가로형 이미지" src="garohyeong.png" style="width: 500px; margin-bottom: 20px;"/>
  <img alt="인트로 퀴즈" src="퀴즈.png" style="width: 850px; margin-bottom: 20px; margin-top: -10px;"/>
  <button class="btn next" onclick="startQuiz()">시작</button>
  <!-- 통계 버튼: 표지 우측 하단에 표시 -->
  <button class="btn stats" onclick="showStats()" style="position:absolute; right:16px; bottom:16px; width:auto; height:auto; padding:8px 12px; font-size:20px; border-radius:6px;">📊 통계 보기</button>
</div>

<div class="quiz-box" id="quiz" style="display:none">
  <img alt="기관 로고" class="topright-logo" src="제목 없음.png"/>
  <div class="quiz-image-wrap">
    <img id="questionImage" src="11번.png" alt="질문 배경 이미지" />
    <div id="quizLabel">#QUIZ 1</div>
  </div>
  <div class="question" id="question" style="font-size: 52px; font-weight: bold; margin-bottom: 10px; padding: 10px;"></div>
  <div class="answer-buttons">
    <button class="btn o" onclick="checkAnswer(true)"><img alt="O" src="o.png"/></button>
    <button class="btn x" onclick="checkAnswer(false)"><img alt="X" src="x.png"/></button>
  </div>
  <img class="bottom-img" src="garohyeong.png"/>
</div>

<div class="quiz-box" id="explanationBox" style="display:none; position: relative;">
  <div class="quiz-image-wrap">
    <img src="11번.png" alt="해설 배경 이미지" />
    <div class="explanation-label">문제 해설</div>
  </div>
  <img alt="기관 로고" class="topright-logo" src="제목 없음.png"/>
  <div id="judgement"></div>
  <div class="explanation" id="explanationText" style="font-weight: bold; margin-bottom: 10px; padding: 10px;"></div>
  <button class="btn next" onclick="nextQuestion()">다음</button>
  <img class="bottom-img" src="garohyeong.png"/>
</div>

<div class="quiz-box" id="finalScreen" style="display:none">
  <img alt="기관 로고" class="topright-logo" src="제목 없음.png"/>
  <img alt="마무리 이미지" src="serohyeong.png"/>
  <div class="explanation" id="finalResult" style="font-size: 68px; font-weight: bold;"></div>
  <p style="font-size: 50px; font-weight: bold; color: #2196f3;">경상북도 이동편의시설 기술지원센터는</p>
  <p style="font-size: 50px; font-weight: bold; color: #2196f3;">교통약자의 이동 편의를 위한 전문 기술을 지원하는 기관입니다.</p>
  <button class="btn reset" onclick="location.reload()">🔄 처음으로</button>
  <!-- 통계 버튼은 표지에 이동됨 -->
</div>

<!-- Load runtime env synchronously from root (preferred) so module can read it immediately. -->
<script src="/env.js"></script>
<script>
  // Backward-compat alias and loaded flag
  try{
    if(typeof window !== 'undefined' && typeof window.__env !== 'undefined' && typeof window._env === 'undefined'){
      window._env = window.__env;
    }
    try{ window.__env_loaded = !!(window.__env); }catch(e){}
  }catch(e){/* ignore */}
</script>
<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm'

  // Runtime env (provide /env.js that sets window.__env)
  const SUPABASE_URL = (window.__env && window.__env.SUPABASE_URL) || null;
  const SUPABASE_ANON_KEY = (window.__env && window.__env.SUPABASE_ANON_KEY) || null;

  let supabase;
  if (SUPABASE_URL && SUPABASE_ANON_KEY) {
    supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  } else {
    console.warn('Supabase keys not found. Create public/env.js with window.__env = { SUPABASE_URL, SUPABASE_ANON_KEY }');
    // Minimal stub so code can run without Supabase configured.
    supabase = {
      from: function() {
        return {
          insert: async function() { return { error: 'supabase-not-configured' }; },
          select: function() {
            const result = { data: [], error: 'supabase-not-configured' };
            const builder = { eq: function(){return builder;}, limit: async function(){return result;}, order:function(){return builder;}, then: function(resolve){ return Promise.resolve(result).then(resolve); } };
            return builder;
          }
        }
      }
    };
  }

  const questions = [
    { text: "유모차 이용자도 교통약자에 포함된다", answer: true, explanation: "장애인, 노령자, 임산부, 영유아를 동반한 사람, 어린이 등이 교통약자에 포함된다." },
    { text: "보도는 이동편의시설 설치 대상이다.", answer: true, explanation: "보도, 여객시설, 교통수단 등이 이동편의시설 설치대상이다." },
    { text: "경상북도 교통약자 이동편의시설 기술지원센터는 광역이동지원 서비스를 실시한다", answer: false, explanation: "실태조사, 교육 및 홍보, 연구조사, 종합상담센터 등 기술관련업무가 주 업무이다." },
    { text: "교통약자도 경상북도 이동편의시설 기술지원센터를 이용할 수 있다.", answer: true, explanation: "관공서, 사업자, 교통약자 모두 이용 가능하다." },
    { text: "대중교통 이용이나 이동에 불편을 느낀적이 있다.", answer: true, explanation: "불편하신 사항에 대해 경상북도 이동편의시설 기술지원센터에 홈페이지 또는 유선전화로 문의 주세요.<br>1566-7710" }
  ];

  let current = 0;
  let score = 0;
  let stats = questions.map(() => ({ o: 0, x: 0 }));
  let sessionId = localStorage.getItem('ox_session_id');
  if(!sessionId){ sessionId = crypto.randomUUID(); localStorage.setItem('ox_session_id', sessionId); }
  let submissionId = null; // per-attempt id

  const params = new URLSearchParams(location.search);
  const quizId = params.get('quiz') || 'ox_default_quiz';

  async function submitAnswer(qIndex, ans){
    try{
      const payload = { quiz_id: quizId, question_index: qIndex, answer: ans, session_id: sessionId, submission_id: submissionId, user_agent: navigator.userAgent, meta: { via: 'qr', submission_id: submissionId } };
      let res = await supabase.from('quiz_responses').insert([payload]);
      if(res && res.error){
        // Retry without submission_id for older DB schemas
        const payload2 = Object.assign({}, payload); delete payload2.submission_id;
        const res2 = await supabase.from('quiz_responses').insert([payload2]);
        if(res2 && res2.error) console.error('submit error (retry) failed', res2.error);
      }
    }catch(e){ console.error(e); }
  }

  function startQuiz(){ try{ submissionId = crypto.randomUUID(); }catch(e){ submissionId = 's_'+Date.now(); } document.getElementById('intro').style.display='none'; document.getElementById('quiz').style.display='flex'; loadQuestion(); }

  function loadQuestion(){ document.getElementById('quiz').style.display='flex'; document.getElementById('explanationBox').style.display='none'; document.getElementById('question').textContent = questions[current].text; const questionImage = document.getElementById('questionImage'); questionImage.src = '11번.png'; document.getElementById('quizLabel').textContent = `#QUIZ ${current + 1}`; questionImage.style.display = 'block'; }

  function checkAnswer(userAnswer){ submitAnswer(current, userAnswer ? 'O' : 'X'); const correct = questions[current].answer; if(userAnswer) stats[current].o++; else stats[current].x++; if(userAnswer === correct) score++; document.getElementById('quiz').style.display='none'; document.getElementById('explanationBox').style.display='flex'; const judge = document.getElementById('judgement'); const exp = document.getElementById('explanationText'); if(current !== 4){ judge.textContent = userAnswer === correct ? '정답입니다!' : '오답입니다!'; judge.className = userAnswer === correct ? 'judgement correct' : 'judgement wrong'; } else { judge.textContent = ''; } exp.innerHTML = questions[current].explanation; }

  function nextQuestion(){ current++; if(current < questions.length) loadQuestion(); else showFinal(); }

  function showFinal(){ document.getElementById('explanationBox').style.display='none'; document.getElementById('finalScreen').style.display='flex'; const percent = questions.length > 0 ? Math.round((score / questions.length) * 100) : 0; document.getElementById('finalResult').textContent = `총 ${questions.length}문제 중 ${score}개 맞추셨습니다! (${percent}점)`; }

  function showStats(){ adminAuthAndShow(); }

  const ADMIN_PASSWORD = '1111';

  async function adminAuthAndShow(skipPrompt = false){
    if(!skipPrompt){ const pwd = prompt('관리자 비밀번호를 입력하세요'); if(!pwd) return; if(pwd !== ADMIN_PASSWORD){ alert('비밀번호가 일치하지 않습니다'); return; } }
    if(!supabase || typeof supabase.from !== 'function'){ alert('Supabase 설정이 없습니다. public/env.js를 배치하세요.'); return; }
    try{
      const { data, error } = await supabase.rpc('get_quiz_statistics', { p_quiz_id: quizId });
      if(error) throw error;
      const panel = document.getElementById('adminPanel'); if(!panel) { alert('관리자 패널을 찾을 수 없습니다.'); return; }
      const contentEl = panel.querySelector('.content'); if(!contentEl) throw new Error('panel .content missing');
      // compute avg from raw rows for accuracy
      let avgScoreDisplay = '0.00';
      try{
        const { data: rows, error: rowsErr } = await supabase.from('quiz_responses').select('answer,question_index,session_id,meta').eq('quiz_id', quizId).limit(100000);
        if(!rowsErr && Array.isArray(rows)){
          const sessions = new Map(); const perQuestionCorrect = Array(questions.length).fill(0); const perQuestionCounts = Array(questions.length).fill(0).map(()=>({ o:0,x:0,total:0 }));
          for(const [i,r] of rows.entries()){
            const qi = Number(r.question_index); const ans = String(r.answer).toUpperCase(); if(typeof qi === 'number' && qi >=0 && qi < perQuestionCounts.length){ if(ans === 'O' || ans === 'TRUE' || ans === 'T') perQuestionCounts[qi].o++; else perQuestionCounts[qi].x++; perQuestionCounts[qi].total++; }
            const correctBool = !!(questions[qi] && questions[qi].answer); const isCorrect = ((ans === 'O' || ans === 'TRUE' || ans === 'T') === correctBool) ? 1 : 0; if(isCorrect) perQuestionCorrect[qi]++; const sid = (r.meta && r.meta.submission_id) || r.submission_id || r.session_id || `row_${i}`; sessions.set(sid, (sessions.get(sid)||0) + isCorrect);
          }
          const participantCount = sessions.size; let sumParticipantPercent = 0; for(const c of sessions.values()){ sumParticipantPercent += (questions.length>0)? (c/questions.length)*100 : 0; } const avgPercent = (participantCount>0)? (sumParticipantPercent/participantCount) : 0; avgScoreDisplay = avgPercent.toFixed(2);
          panel._perQuestionCorrect = perQuestionCorrect; panel._perQuestionCounts = perQuestionCounts; panel._totalResponses = rows.length; panel._participantCount = participantCount;
        }
      }catch(e){ console.warn('failed to fetch rows for avg calc', e); }

      // render using RPC plus raw-row overrides when available
      const rpcRows = Array.isArray(data)? data.sort((a,b)=>(a.question_index||0)-(b.question_index||0)):[];
      const panelPerQ = panel._perQuestionCorrect || null; const panelPerCounts = panel._perQuestionCounts || null; const computedParticipantCount = panel._participantCount || null; const displayParticipants = computedParticipantCount !== null ? computedParticipantCount : (rpcRows[0] && rpcRows[0].total_participants) || (panel._totalResponses || 0);
      let html = `<div style="padding:12px; max-height:360px; overflow:auto; font-size:14px;"><div style="margin-bottom:8px;"><strong>참여인원:</strong> ${displayParticipants}</div><div style="margin-bottom:8px;"><strong>평균 점수:</strong> ${avgScoreDisplay} 점</div><div style="margin-bottom:6px; font-weight:bold;">문항별 결과</div>`;
      for(let i=0;i<questions.length;i++){
        const row = rpcRows.find(r=>Number(r.question_index)===i) || null; let countO=0,countX=0,total=0; if(panelPerCounts && typeof panelPerCounts[i] !== 'undefined'){ countO = Number(panelPerCounts[i].o||0); countX = Number(panelPerCounts[i].x||0); total = Number(panelPerCounts[i].total||0); } else { countO = row?Number(row.count_o||0):0; countX = row?Number(row.count_x||0):0; total = row?Number(row.total_responses||0):0; }
        let correctRate = 0; if(panelPerQ && typeof panelPerQ[i] !== 'undefined' && total>0){ correctRate = ((panelPerQ[i]/total)*100).toFixed(2); } else { correctRate = row?Number(row.correct_rate||0):0; }
        html += `<div style="margin-bottom:6px;"><strong>Q${i+1}</strong>: O=${countO} &nbsp; X=${countX} &nbsp; (총 ${total}) &nbsp; <em>정답률: ${correctRate}%</em></div>`;
      }
      html += `</div>`; contentEl.innerHTML = html; panel.style.display='block'; panel.scrollIntoView({behavior:'smooth'});

    }catch(rpcErr){
      // fallback: aggregate client-side
      try{
        const { data, error } = await supabase.from('quiz_responses').select('*').eq('quiz_id', quizId).limit(100000);
        if(error){ alert('통계를 불러오는 중 오류가 발생했습니다: '+(error.message||JSON.stringify(error))); return; }
        const agg = {}; const perSessionScore = {};
        for(const [i,r] of (data||[]).entries()){
          const qi = Number(r.question_index); const ans = String(r.answer).toUpperCase(); if(!agg[qi]) agg[qi] = {O:0,X:0,total:0,correctCount:0}; if(ans==='O'||ans==='TRUE'||ans==='T') agg[qi].O++; else agg[qi].X++; agg[qi].total++; const correctAnswerIsO = !!(questions[qi] && questions[qi].answer); const isCorrect = ((ans==='O'||ans==='TRUE'||ans==='T')===correctAnswerIsO)?1:0; agg[qi].correctCount = (agg[qi].correctCount||0)+isCorrect; const sessionKey = (r.meta&&r.meta.submission_id)||r.submission_id||r.session_id||`row_${i}`; perSessionScore[sessionKey] = (perSessionScore[sessionKey]||0)+isCorrect;
        }
        const participantIds = Object.keys(perSessionScore); const totalParticipants = participantIds.length; const totalCorrectSum = participantIds.length>0?participantIds.reduce((acc,id)=>acc+(perSessionScore[id]||0),0):0; const avgScorePercent = (totalParticipants>0&&questions.length>0)?(totalCorrectSum/(totalParticipants*questions.length))*100:0; const avgScoreDisplay = avgScorePercent.toFixed(2);
        const totalResponses = Array.isArray(data)?data.length:0; let html = `<div style="padding:12px; max-height:360px; overflow:auto; font-size:14px;"><div style="margin-bottom:8px;"><strong>참여인원:</strong> ${totalParticipants}</div><div style="margin-bottom:8px;"><strong>평균 점수:</strong> ${avgScoreDisplay} 점</div><div style="margin-bottom:6px; font-weight:bold;">문항별 결과</div>`;
        for(let i=0;i<questions.length;i++){ const a = agg[i] || {O:0,X:0,total:0,correctCount:0}; const correctCount = (typeof a.correctCount !== 'undefined' && a.correctCount !== null)? a.correctCount : (questions[i] && questions[i].answer ? a.O : a.X); const correctRate = a.total ? ((correctCount / a.total) * 100).toFixed(2) : '0.00'; html += `<div style="margin-bottom:6px;"><strong>Q${i+1}</strong>: O=${a.O} &nbsp; X=${a.X} &nbsp; (총 ${a.total}) &nbsp; <em>정답률: ${correctRate}%</em></div>`; }
        html += `</div>`; const panel = document.getElementById('adminPanel'); const contentEl = panel.querySelector('.content'); contentEl.innerHTML = html; panel.style.display='block'; panel.scrollIntoView({behavior:'smooth'});
      }catch(e){ console.error(e); alert('오류'); }
    }
  }

  async function resetStatistics(){ const pwd = prompt('관리자 비밀번호를 입력하세요'); if(!pwd) return; if(pwd !== ADMIN_PASSWORD){ alert('비밀번호가 일치하지 않습니다'); return; } if(!confirm('정말 이 퀴즈의 모든 응답을 삭제하고 통계를 초기화하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) return; try{ const panel = document.getElementById('adminPanel'); const contentEl = panel && panel.querySelector && panel.querySelector('.content'); if(contentEl) contentEl.innerHTML = '<div style="padding:12px;">초기화 중...(RPC 호출)</div>'; const { data, error } = await supabase.rpc('reset_quiz_statistics', { p_quiz_id: quizId }); if(error){ if(contentEl) contentEl.innerHTML = '<div style="padding:12px; color:#a00;">RPC 실패: '+(error.message||JSON.stringify(error))+'</div>'; alert('RPC로 초기화하는데 실패했습니다:\n'+(error.message||JSON.stringify(error))+'\n폴백으로 삭제를 시도합니다. 콘솔을 확인하세요.'); throw error; } if(contentEl) contentEl.innerHTML = '<div style="padding:12px; color:green;">통계가 초기화되었습니다. (RPC)</div>'; alert('통계가 초기화되었습니다. (RPC)'); try{ adminAuthAndShow(true); }catch(e){} return; }catch(e){ console.warn('RPC reset failed, falling back to client-side delete', e); } try{ const panel = document.getElementById('adminPanel'); const contentEl = panel && panel.querySelector && panel.querySelector('.content'); if(contentEl) contentEl.innerHTML = '<div style="padding:12px;">초기화 중...(삭제 호출)</div>'; const { data, error } = await supabase.from('quiz_responses').delete().eq('quiz_id', quizId); if(error){ if(contentEl) contentEl.innerHTML = '<div style="padding:12px; color:#a00;">삭제 실패: '+(error.message||JSON.stringify(error))+'</div>'; alert('초기화 실패: '+(error.message||JSON.stringify(error))+'\n브라우저 콘솔의 자세한 정보를 확인하세요.'); return; } const deletedCount = Array.isArray(data) ? data.length : (data && data.count) ? data.count : '알 수 없음'; if(contentEl) contentEl.innerHTML = '<div style="padding:12px; color:green;">통계가 초기화되었습니다. (삭제 방식) 삭제된 항목: '+deletedCount+'</div>'; alert('통계가 초기화되었습니다. (삭제 방식)'); try{ adminAuthAndShow(true); }catch(e){} }catch(e){ console.error('reset error', e); alert('초기화 도중 오류가 발생했습니다. 서버 측에서 RPC(reset_quiz_statistics)를 만드는 것을 권장합니다.'); } }

  // expose to window for inline handlers
  window.startQuiz = startQuiz; window.checkAnswer = checkAnswer; window.nextQuestion = nextQuestion; window.showStats = showStats; window.resetStatistics = resetStatistics; window.adminAuthAndShow = adminAuthAndShow; try{ window.supabase = supabase; }catch(e){}

  document.addEventListener('DOMContentLoaded', ()=>{
    const panel = document.getElementById('adminPanel'); if(panel){ let content = panel.querySelector('.content'); if(!content){ content = document.createElement('div'); content.className = 'content'; content.style.padding = '8px 12px'; content.style.fontSize = '13px'; content.style.color = '#111'; content.textContent = '로딩 중...'; const footer = panel.querySelector('div[style*="border-top"]'); panel.insertBefore(content, footer || null); } }
  });
</script>
<!-- 관리자 통계 패널 (초기 상태는 숨김) -->
<div id="adminPanel" style="display:none; position:fixed; right:12px; bottom:12px; width:360px; max-width:90%; background:#fff; border:2px solid #2196f3; border-radius:8px; box-shadow:0 6px 18px rgba(0,0,0,0.2); z-index:9999; font-family: sans-serif;">
  <div style="display:flex; align-items:center; justify-content:space-between; padding:8px 12px; border-bottom:1px solid #eee; background:#f7fbff;">
    <strong style="font-size:14px;">관리자 통계</strong>
    <button onclick="document.getElementById('adminPanel').style.display='none'" style="border:none; background:transparent; cursor:pointer; font-size:18px;">✕</button>
  </div>
  <div class="content" style="padding:8px 12px; font-size:13px; color:#111">로딩 중...</div>
  <div style="padding:8px 12px; border-top:1px solid #eee; text-align:right;">
    <button onclick="resetStatistics()" style="margin-right:8px; padding:6px 10px; border-radius:6px; border:none; background:#e53935; color:#fff; cursor:pointer">초기화</button>
    <button onclick="document.getElementById('adminPanel').style.display='none'" style="padding:6px 10px; border-radius:6px; border:none; background:#607d8b; color:#fff; cursor:pointer">닫기</button>
  </div>
</div>
</body>
</html>
